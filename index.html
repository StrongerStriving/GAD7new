<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ GAD-7 & Theo dõi Tiến trình</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Tải Chart.js cho Biểu đồ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4; /* Màu nền nhẹ nhàng, xanh mint */
        }
        /* Styling cho các ô nhập liệu radio để dễ nhìn hơn */
        .custom-radio {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            display: inline-block;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            border: 2px solid #6ee7b7;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .custom-radio:checked {
            background-color: #059669;
            border-color: #059669;
            box-shadow: 0 0 0 3px #d1fae5;
        }
        /* Ẩn tiêu đề cột trên mobile */
        @media (max-width: 768px) {
            .table-header { display: none; }
            .question-row { grid-template-columns: 1fr; border-bottom: 1px solid #e5e7eb; padding: 1rem 0; }
            .question-text { margin-bottom: 0.5rem; font-weight: 600; }
            .score-options { display: flex; flex-wrap: wrap; gap: 0.5rem; }
            .score-options label { flex-grow: 1; min-width: 45%; padding: 0.5rem; background-color: #f9fafb; border-radius: 0.5rem; }
        }
    </style>
    
    <!-- FIREBASE CDNs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, orderBy, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Thiết lập mức độ log để debug (tùy chọn)
        setLogLevel('Debug');

        // Biến toàn cục từ Canvas Environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db = null;
        let auth = null;
        let userId = null;
        let isAuthReady = false;

        // Định nghĩa các phần tử DOM
        const totalScoreDisplay = document.getElementById('totalScoreDisplay');
        const resultInterpretation = document.getElementById('resultInterpretation');
        const saveTestButton = document.getElementById('saveTestButton');
        const chartCanvas = document.getElementById('scoreChart');
        const userNameInput = document.getElementById('userName');
        const testDateInput = document.getElementById('testDate');
        const userIdDisplay = document.getElementById('userIdDisplay');

        // Hàm khởi tạo Firebase
        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Set persistence to session to maintain login across tab/session
                await setPersistence(auth, browserSessionPersistence);

                // Đăng nhập/Xác thực người dùng
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Lắng nghe thay đổi trạng thái xác thực
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        userIdDisplay.textContent = `ID Người Dùng: ${userId}`;
                        console.log("Firebase Auth Ready. User ID:", userId);
                        // Tải dữ liệu lịch sử ngay khi auth sẵn sàng
                        loadHistoryAndDrawChart();
                    } else {
                        userId = null;
                        isAuthReady = true;
                        userIdDisplay.textContent = 'Đăng nhập ẩn danh...';
                        console.log("Anonymous Sign In failed or state changed.");
                    }
                });

            } catch (error) {
                console.error("Lỗi khi khởi tạo hoặc xác thực Firebase:", error);
                userIdDisplay.textContent = 'Lỗi Auth: ' + error.message;
            }
        }

        // Hàm tính điểm (giữ nguyên logic)
        function calculateScore() {
            const form = document.getElementById('gad7Form');
            let totalScore = 0;
            let questionsAnswered = true;
            
            for (let i = 1; i <= 7; i++) {
                const checkedRadio = form.querySelector(`input[name="q${i}"]:checked`);
                if (checkedRadio) {
                    totalScore += parseInt(checkedRadio.value);
                } else {
                    questionsAnswered = false;
                }
            }

            totalScoreDisplay.textContent = totalScore;
            
            if (questionsAnswered) {
                displayResult(totalScore);
                saveTestButton.disabled = false;
                saveTestButton.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                resultInterpretation.innerHTML = '<p class="text-gray-500 italic">Vui lòng hoàn thành 7 câu hỏi trên để nhận kết quả.</p>';
                resultInterpretation.className = "text-center p-4 rounded-lg bg-white border border-gray-200";
                saveTestButton.disabled = true;
                saveTestButton.classList.add('opacity-50', 'cursor-not-allowed');
            }
            return { totalScore, questionsAnswered };
        }

        // Hàm diễn giải kết quả
        function interpretScore(score) {
            let interpretation = { level: "Lo âu tối thiểu (0-4)", description: "Mức độ lo âu rất nhẹ hoặc không có. Không cần theo dõi thêm tại thời điểm này.", color: "bg-green-100 text-green-800 border-green-500" };
            if (score >= 5 && score <= 9) { interpretation = { level: "Lo âu nhẹ (5-9)", description: "Mức độ lo âu nhẹ. Nên theo dõi các triệu chứng và xem xét lặp lại đánh giá sau một thời gian.", color: "bg-yellow-100 text-yellow-800 border-yellow-500" }; } 
            else if (score >= 10 && score <= 14) { interpretation = { level: "Lo âu vừa/trung bình (10-14)", description: "Mức độ lo âu vừa/trung bình. Điểm số này thường cần đánh giá lâm sàng sâu hơn và có thể xem xét các can thiệp điều trị.", color: "bg-orange-100 text-orange-800 border-orange-500" }; } 
            else if (score >= 15) { interpretation = { level: "Lo âu nặng (15-21)", description: "Mức độ lo âu nặng. Triệu chứng lo âu ở mức độ nghiêm trọng và cần được thăm khám, can thiệp điều trị tích cực ngay lập tức.", color: "bg-red-100 text-red-800 border-red-500" }; }
            return interpretation;
        }

        function displayResult(score) {
            const result = interpretScore(score);
            resultInterpretation.className = `p-4 rounded-lg border-2 ${result.color}`;
            resultInterpretation.innerHTML = `
                <div class="text-xl md:text-2xl font-bold mb-2">Mức độ Lo âu: <span class="uppercase">${result.level}</span></div>
                <p class="text-sm">${result.description}</p>
            `;
        }

        // Hàm lưu trữ kết quả vào Firestore
        async function saveTestResult() {
            if (!isAuthReady || !userId || !db) {
                console.error("Firebase chưa sẵn sàng hoặc không có userId.");
                // Thay alert bằng thông báo trên UI
                displayMessage("Lỗi: Hệ thống chưa sẵn sàng để lưu dữ liệu. Vui lòng thử lại.", 'bg-red-500');
                return;
            }

            const { totalScore, questionsAnswered } = calculateScore();
            if (!questionsAnswered) {
                displayMessage("Vui lòng hoàn thành tất cả các câu hỏi trước khi lưu.", 'bg-yellow-500');
                return;
            }

            const userName = userNameInput.value.trim() || 'Người dùng ẩn danh';
            const testDate = testDateInput.value;
            const docRef = doc(collection(db, `artifacts/${appId}/users/${userId}/gad7_results`));
            
            // Dữ liệu sẽ lưu
            const dataToSave = {
                score: totalScore,
                date: testDate,
                userName: userName,
                timestamp: Date.now(),
                serverTimestamp: serverTimestamp()
            };

            try {
                await setDoc(docRef, dataToSave);
                localStorage.setItem('gad7_userName', userName); // Lưu tên cục bộ
                displayMessage("Kết quả đã được lưu thành công!", 'bg-green-500');
                await loadHistoryAndDrawChart(); // Tải lại và vẽ biểu đồ
            } catch (error) {
                console.error("Lỗi khi lưu dữ liệu vào Firestore:", error);
                displayMessage(`Lỗi khi lưu: ${error.message}`, 'bg-red-500');
            }
        }

        // --- Logic Biểu đồ ---
        let chartInstance = null;
        
        function drawChart(historyData) {
            if (chartInstance) {
                chartInstance.destroy(); // Hủy biểu đồ cũ nếu có
            }
            
            if (!chartCanvas) return;

            // Sắp xếp dữ liệu theo ngày (timestamp)
            const sortedData = historyData.sort((a, b) => a.timestamp - b.timestamp);

            const labels = sortedData.map(d => {
                const date = new Date(d.date + 'T00:00:00'); // Đảm bảo múi giờ địa phương
                return date.toLocaleDateString('vi-VN');
            });
            const scores = sortedData.map(d => d.score);

            const ctx = chartCanvas.getContext('2d');
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Điểm Lo âu (GAD-7)',
                        data: scores,
                        borderColor: '#047857', // Màu xanh Teal
                        backgroundColor: 'rgba(5, 150, 105, 0.2)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#059669',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            min: 0,
                            max: 21,
                            title: {
                                display: true,
                                text: 'Tổng điểm (0-21)'
                            },
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Biểu đồ Theo dõi Điểm Lo âu Cá nhân',
                            font: { size: 16 }
                        }
                    }
                }
            });
            
            // Cập nhật tên người dùng (lấy từ dữ liệu mới nhất)
            if (historyData.length > 0) {
                userNameInput.value = historyData[historyData.length - 1].userName;
            }
        }

        // Hàm tải lịch sử và vẽ biểu đồ
        async function loadHistoryAndDrawChart() {
            if (!isAuthReady || !userId || !db) {
                // Sẽ gọi lại sau khi Auth sẵn sàng
                return;
            }

            const colRef = collection(db, `artifacts/${appId}/users/${userId}/gad7_results`);
            const q = query(colRef); 
            // KHÔNG dùng orderBy('timestamp') để tránh lỗi thiếu index, lọc bằng JS

            // Sử dụng onSnapshot để cập nhật real-time
            onSnapshot(q, (snapshot) => {
                const historyData = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    historyData.push({
                        id: doc.id,
                        score: data.score,
                        date: data.date,
                        timestamp: data.timestamp, // Dùng timestamp để sắp xếp
                        userName: data.userName || 'Người dùng ẩn danh'
                    });
                });

                // Sắp xếp dữ liệu bằng JS
                historyData.sort((a, b) => a.timestamp - b.timestamp);
                
                if (historyData.length > 0) {
                    drawChart(historyData);
                } else {
                    // Hiển thị thông báo nếu không có dữ liệu
                    if (chartInstance) chartInstance.destroy();
                    chartCanvas.style.display = 'none';
                    document.getElementById('noDataMessage').style.display = 'block';
                }
            }, (error) => {
                console.error("Lỗi khi tải lịch sử từ Firestore:", error);
                displayMessage(`Lỗi tải dữ liệu: ${error.message}`, 'bg-red-500');
            });
        }
        
        // --- Hàm thông báo thay thế alert() ---
        function displayMessage(message, bgColor) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-xl text-white font-semibold transition-opacity duration-300 ${bgColor}`;
            messageBox.style.opacity = 1;
            setTimeout(() => {
                messageBox.style.opacity = 0;
            }, 3000);
        }


        // --- Khởi tạo ---
        document.addEventListener('DOMContentLoaded', () => {
            // Đặt ngày hôm nay làm giá trị mặc định cho input ngày
            const today = new Date().toISOString().split('T')[0];
            testDateInput.value = today;

            // Tải tên người dùng đã lưu cục bộ (nếu có)
            const savedUserName = localStorage.getItem('gad7_userName');
            if (savedUserName) {
                userNameInput.value = savedUserName;
            }

            // Gán sự kiện cho form
            const form = document.getElementById('gad7Form');
            form.addEventListener('change', calculateScore);
            saveTestButton.addEventListener('click', saveTestResult);
            
            // Khởi tạo Firebase
            initializeFirebase();

            // Chạy lần đầu tiên để thiết lập trạng thái ban đầu
            calculateScore();
        });
    </script>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-5xl mx-auto bg-white shadow-2xl rounded-xl overflow-hidden">
        
        <!-- Header -->
        <header class="bg-teal-600 p-6 text-white text-center rounded-t-xl">
            <h1 class="text-3xl font-bold">CÔNG CỤ TẦM SOÁT VÀ THEO DÕI LO ÂU GAD-7</h1>
            <p class="mt-1 text-sm opacity-90">Tích hợp Lưu trữ & Biểu đồ Tiến trình (Bản dành cho Cộng đồng)</p>
        </header>

        <div class="p-6 md:p-8">

            <!-- Thông tin Người dùng & Ngày làm test -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg border">
                <div class="md:col-span-1">
                    <label for="userName" class="block text-sm font-medium text-gray-700">Tên người dùng:</label>
                    <input type="text" id="userName" placeholder="Nhập tên của bạn" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 p-2" required>
                </div>
                <div class="md:col-span-1">
                    <label for="testDate" class="block text-sm font-medium text-gray-700">Ngày làm test:</label>
                    <input type="date" id="testDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 p-2" required>
                </div>
                <div class="md:col-span-1 flex items-end">
                    <p id="userIdDisplay" class="text-xs text-gray-500 italic truncate w-full pt-1">Đang kết nối...</p>
                </div>
            </div>

            <!-- Hướng dẫn -->
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg mb-6">
                <p class="text-sm text-blue-800 font-semibold">
                    <span class="font-bold">Hướng dẫn:</span> Đánh dấu vào mức độ thường xuyên bạn bị phiền toái bởi các vấn đề sau **trong vòng 2 tuần qua**.
                </p>
            </div>

            <!-- Questionnaire Form -->
            <form id="gad7Form">
                <!-- Header cho Desktop -->
                <div class="table-header hidden md:grid grid-cols-6 gap-2 bg-gray-100 py-3 px-3 rounded-t-lg text-gray-500 uppercase text-xs font-semibold border-b">
                    <div class="col-span-2 text-left">Vấn đề</div>
                    <div class="text-center">0. Không chút nào</div>
                    <div class="text-center">1. Vài ngày</div>
                    <div class="text-center">2. Hơn nửa số ngày</div>
                    <div class="text-center">3. Gần như mọi ngày</div>
                </div>

                <!-- Questions Q1 to Q7 - Sử dụng Flex/Grid để Responsive -->
                <div id="questionnaireList" class="divide-y divide-gray-200">
                    <!-- Q1 -->
                    <div class="question-row md:grid md:grid-cols-6 md:gap-2 py-4 px-3 hover:bg-gray-50 transition duration-150">
                        <div class="question-text md:col-span-2 text-sm text-gray-700">1. Cảm thấy căng thẳng, lo lắng hoặc bồn chồn.</div>
                        <div class="score-options md:contents text-center">
                            <label class="block md:inline-block"><input type="radio" name="q1" value="0" class="custom-radio" required> <span class="md:hidden">0. Không chút nào</span></label>
                            <label class="block md:inline-block"><input type="radio" name="q1" value="1" class="custom-radio"> <span class="md:hidden">1. Vài ngày</span></label>
                            <label class="block md:inline-block"><input type="radio" name="q1" value="2" class="custom-radio"> <span class="md:hidden">2. Hơn nửa số ngày</span></label>
                            <label class="block md:inline-block"><input type="radio" name="q1" value="3" class="custom-radio"> <span class="md:hidden">3. Gần như mọi ngày</span></label>
                        </div>
                    </div>
                    <!-- Q2 -->
                    <div class="question-row md:grid md:grid-cols-6 md:gap-2 py-4 px-3 hover:bg-gray-50 transition duration-150 bg-gray-50 md:bg-white">
                        <div class="question-text md:col-span-2 text-sm text-gray-700">2. Không thể ngừng hoặc kiểm soát sự lo lắng.</div>
                        <div class="score-options md:contents text-center">
                            <label class="block md:inline-block"><input type="radio" name="q2" value="0" class="custom-radio" required> <span class="md:hidden">0. Không chút nào</span></label>
                            <label class="block md:inline-block"><input type="radio" name="q2" value="1" class="custom-radio"> <span class="md:hidden">1. Vài ngày</span></label>
                            <label class="block md:inline-block"><input type="radio" name="q2" value="2" class="custom-radio"> <span class="md:hidden">2. Hơn nửa số ngày</span></label>
                            <label class="block md:inline-block"><input type="radio" name="q2" value="3" class="custom-radio"> <span class="md:hidden">3. Gần như mọi ngày</span></label>
                        </div>
                    </div>
                    <!-- Q3 -->
                    <div class="question-row md:grid md:grid-cols-6 md:gap-2 py-4 px-3 hover:bg-gray-50 transition duration-150">
                        <div class="question-text md:col-span-2 text-sm text-gray-700">3. Lo lắng quá mức về nhiều điều khác nhau trong cuộc sống.</div>
                        <div class="score-options md:contents text-center">
                            <label class="block md:inline-block"><input type="radio" name="q3" value="0" class="custom-radio" required> <span class="md:hidden">0. Không chút nào</span></label>
                            <label class="block md:inline-block"><input type="radio" name="q3" value="1" class="custom-radio"> <span class="md:hidden">1. Vài ngày</span></label>
                            <label class="block md:inline-block"><input type="radio" name="q3" value="2" class="custom-radio"> <span class="md:hidden">2. Hơn nửa số ngày</span></label>
                            <label class="block md:inline-block"><input type="radio" name="q3" value="3" class="custom-radio"> <span class="md:hidden">3. Gần như mọi ngày</span></label>
                        </div>
                    </div>
                    <!-- Q4 -->
                    <div class="question-row md:grid md:grid-cols-6 md:gap-2 py-4 px-3 hover:bg-gray-50 transition duration-150 bg-gray-50 md:bg-white">
                        <div class="question-text md:col-span-2 text-sm text-gray-700">4. Khó thư giãn.</div>
                        <div class="score-options md:contents text-center">
                            <label class="block md:inline-block"><input type="radio" name="q4" value="0" class="custom-radio" required> <span class="md:hidden">0. Không chút nào</span></label>
                            <label class="block md:inline-block"><input type="radio" name="q4" value="1" class="custom-radio"> <span class="md:hidden">1. Vài ngày</span></label>
                            <label class="block md:inline-block"><input type="radio" name="q4" value="2" class="custom-radio"> <span class="md:hidden">2. Hơn nửa số ngày</span></label>
                            <label class="block md:inline-block"><input type="radio" name="q4" value="3" class="custom-radio"> <span class="md:hidden">3. Gần như mọi ngày</span></label>
                        </div>
                    </div>
                    <!-- Q5 -->
                    <div class="question-row md:grid md:grid-cols-6 md:gap-2 py-4 px-3 hover:bg-gray-50 transition duration-150">
                        <div class="question-text md:col-span-2 text-sm text-gray-700">5. Bồn chồn/bứt rứt đến mức khó ngồi yên.</div>
                        <div class="score-options md:contents text-center">
                            <label class="block md:inline-block"><input type="radio" name="q5" value="0" class="custom-radio" required> <span class="md:hidden">0. Không chút nào</span></label>
                            <label class="block md:inline-block"><input type="radio" name="q5" value="1" class="custom-radio"> <span class="md:hidden">1. Vài ngày</span></label>
